"use strict";angular.module("gogogoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","angular.filter","rzModule"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",controllerAs:"explore"}).when("/",{redirectTo:"/home"}).otherwise({redirectTo:"/home"})}]),angular.module("gogogoApp").controller("HomeCtrl",function(){}),angular.module("gogogoApp").controller("ExploreCtrl",["$scope","apiservice",function(a,b){a.routes,a.teams,a.errors,a.filters={bike:!0,walking:!0,selectedTeam:!1};var c=d3.timeFormat("%d/%m %H:%M");a.slider={minValue:0,maxValue:0,options:{ceil:0,floor:0,step:6e4,translate:function(a){return c(new Date(a))}}},a.onSelectedTeam=function(b,c,d,e){a.filters.selectedTeam=b},a.removeTeam=function(){a.filters.selectedTeam=!1},b.getRoutes().then(function(b){a.routes=b.routes,a.teams=b.teams,a.slider.minValue=b.dates[0],a.slider.options.floor=b.dates[0],a.slider.maxValue=b.dates[1],a.slider.options.ceil=b.dates[1]},function(b){a.errors=b})}]),angular.module("gogogoApp").factory("apiservice",["$http","$q","parseRoutesFilter",function(a,b,c){var d="http://149.210.213.121";return{getRoutes:function(e){var f=b.defer(),g="/getdataapp";return a({method:"GET",cache:!1,url:d+(e?g+"/"+e:g)}).success(function(a){f.resolve(c(a))}).error(function(){f.reject("An error occured while fetching data")}),f.promise}}}]),angular.module("gogogoApp").filter("parseRoutes",function(){return function(a){var b={},c=a.map(function(a){var b={tm:a.transport_method,distance:+a.distance_inkm,id:a._id,teamid:a.teamid,endDatetime:+a.endDatetime,startDatetime:+a.startDatetime},c=polyline.decode(a.lineString),d=turf.lineString(c,b);return d}),d=d3.nest().key(function(a){return a.teamid}).map(a);return b.routes=turf.flip(turf.featureCollection(c)),b.teams=d.keys(),b.dates=[d3.min(a,function(a){return a.startDatetime}),d3.max(a,function(a){return a.endDatetime})],b.dates[1]=d3.timeMinute.ceil(new Date(b.dates[1])).getTime(),b.dates[0]=d3.timeMinute.floor(new Date(b.dates[0])).getTime(),b}}),angular.module("gogogoApp").directive("map",["$timeout","$window",function(a,b){return{restrict:"A",replace:!1,link:function(a,b,c){mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var d=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v9",center:[4.9,52.3667],minZoom:12,maxZoom:17,zoom:13}),e=function(a){d.addSource("routes",{type:"geojson",data:a}),d.addLayer({id:"routes",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,0,0,0.5)","line-width":2}}),d.addLayer({id:"routes-hover",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,0,0,1)","line-width":3},filter:["==","id",""]}),d.on("mousemove",function(a){var b=d.queryRenderedFeatures(a.point,{layers:["routes"]});d.getCanvas().style.cursor=b.length?"pointer":"",b.length?d.setFilter("routes-hover",["==","id",b[0].properties.id]):d.setFilter("routes-hover",["==","id",""])}),d.on("mouseout",function(){d.setFilter("routes-hover",["==","id",""])});var b=turf.bbox(a);d.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:100})};a.$watch("routes.features.length",function(b,c){b!=c&&b&&(d.loaded()?e(a.routes):d.on("load",function(){e(a.routes)}))}),a.$watchGroup(["filters.bike","filters.walking","filters.selectedTeam","slider.minValue","slider.maxValue"],function(a,b,c){if(a[3]&&a[4]&&d.loaded()){var e=["in","tm"];a[0]&&e.push("bike"),a[1]&&e.push("walking"),a[2]?d.setFilter("routes",["all",e,["==","teamid",a[2]],[">","startDatetime",a[3]],["<","endDatetime",a[4]]]):d.setFilter("routes",["all",e,[">","startDatetime",a[3]],["<","endDatetime",a[4]]])}})}}}]),angular.module("gogogoApp").directive("minimap",function(){return{restrict:"A",replace:!1,scope:{route:"="},link:function(a,b,c){var d=a.route,e=100,f=100,g=d3.select(b[0]).append("canvas").attr("width",e).attr("height",f),h=g.node().getContext("2d"),i=d3.geoMercator().fitSize([e,f],d),j=d3.geoPath().projection(i).context(h);j(d),h.stroke()}}}),angular.module("gogogoApp").filter("routes",function(){return function(a,b,c){if(a)return a=a.filter(function(a){var d=!!b.bike&&"bike",e=!!b.walking&&"walking",f=a.properties.startDatetime>=c.minValue&&a.properties.endDatetime<=c.maxValue;return b.selectedTeam?(a.properties.tm==d||a.properties.tm==e)&&a.properties.teamid==b.selectedTeam&&f:a.properties.tm==d||a.properties.tm==e&&f})}}),angular.module("gogogoApp").directive("slideraxes",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d=d3.select(b[0]),e=b[0].getBoundingClientRect().width,f=30,g={top:5,right:0,bottom:5,left:0},h=e-g.left-g.right,i=(f-g.top-g.bottom,d.append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+g.left+","+g.top+")")),j=new Date(a.slider.options.floor),k=new Date(a.slider.options.ceil),l=d3.scaleTime().domain([j,k]).range([0,h]),m=d3.axisBottom(l).tickSizeOuter(0);i.call(m),a.$watch("slider.options",function(a,b){if(a!=b){var c=new Date(a.floor),d=new Date(a.ceil);l.domain([c,d]),i.call(m)}},!0)}}}),angular.module("gogogoApp").run(["$templateCache",function(a){a.put("views/explore.html",'<div class="container-fluid fullHeight"> <div class="row fullHeight"> <div class="col-md-6 fullHeight"> <div class="filtersContainer"> <h3>GoGoGo</h3> <div class="row"> <div class="col-md-6"> <input type="text" ng-model="searchTeam" placeholder="Search team" typeahead-on-select="onSelectedTeam($item, $model, $label, $event)" uib-typeahead="team for team in teams | filter:$viewValue " class="form-control"> </div> <div class="col-md-6"> <button ng-if="filters.selectedTeam" ng-click="removeTeam()" type="button" class="btn btn-default"> {{filters.selectedTeam}} <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span> </button> </div> </div> <div class="checkbox"> <label> <input type="checkbox" ng-model="filters.bike"> Bike </label> </div> <div class="checkbox"> <label> <input type="checkbox" ng-model="filters.walking"> Walking </label> </div> <rzslider rz-slider-model="slider.minValue" rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider> <div style="width:100%" slideraxes> </div> </div> <div class="routesContainer"> <div ng-repeat="(key, value) in routes.features |  limitTo: 10 | routes:filters:slider | groupBy: \'properties.teamid\'"> <h3>{{key}}</h3> <div ng-repeat="route in value"> <p> {{route.properties.tm}} - {{route.properties.distance}}km - in {{(route.properties.endDatetime-route.properties.startDatetime) | date:\'HH:mm:ss\':\'+000\'}} </p> <p> Started on {{route.properties.startDatetime | date:\'MMM d, y\'}} at {{route.properties.startDatetime | date:\'HH:mm:ss\'}} and arrived at {{route.properties.endDatetime | date:\'HH:mm:ss\'}} </p> <div minimap route="route"></div> </div> </div> </div> </div> <div class="col-md-6 fullHeight"> <div id="map" class="fullHeight" map></div> </div> </div> </div>'),a.put("views/home.html",'<div class="container"> <div class="jumbotron"> <h1>GOGOGO is in da house!</h1> </div> </div> <div class="container"> <div class="row"> <div class="col-md-12"> <p> ready to type cool stuff. </p> <a href="#/explore" class="btn btn-default" role="button">try the app</a> </div> </div> </div>')}]);