"use strict";angular.module("gogogoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","angular.filter","rzModule"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",controllerAs:"explore"}).when("/",{redirectTo:"/home"}).otherwise({redirectTo:"/home"})}]),angular.module("gogogoApp").controller("HomeCtrl",function(){}),angular.module("gogogoApp").controller("ExploreCtrl",["$scope","apiservice",function(a,b){a.routes,a.singleRoute,a.teams,a.errors,a.filters={bike:!0,walking:!0,selectedTeam:"",minValue:"",maxValue:""},a.isOpen=!1;var c=d3.timeFormat("%d/%m %H:%M");a.slider={minValue:0,maxValue:0,options:{ceil:0,floor:0,step:6e4,noSwitching:!0,translate:function(a){return c(new Date(a))},onEnd:function(b,c,d,e){"min"==e?a.filters.minValue=c:a.filters.maxValue=d}}},a.onSelectedTeam=function(b,c,d,e){a.removeSingleRoute(),a.filters.selectedTeam=b},a.removeTeam=function(){a.filters.selectedTeam=""},a.removeSingleRoute=function(){a.singleRoute=null},a.getSingleRoute=function(c,d){a.singleRoute&&d==a.singleRoute.features[0].properties.id?a.removeSingleRoute():b.getSingleRoute(c,d).then(function(b){a.singleRoute=b},function(b){a.errors=b})},b.getRoutes().then(function(b){a.routes=b.routes,a.teams=b.teams,a.teamsList=b.teamsList,a.slider.minValue=b.dates[0],a.filters.minValue=b.dates[0],a.slider.options.floor=b.dates[0],a.slider.maxValue=b.dates[1],a.filters.maxValue=b.dates[1],a.slider.options.ceil=b.dates[1]},function(b){a.errors=b})}]),angular.module("gogogoApp").factory("apiservice",["$http","$q","parseRoutesFilter","parseSingleRouteFilter",function(a,b,c,d){var e="http://149.210.213.121";return{getRoutes:function(d,f){var g=b.defer(),h="/getdataapp",i=d?f?h+"/"+d+"/"+f:h+"/"+d:h;return a({method:"GET",cache:!1,url:e+i}).success(function(a){g.resolve(c(a))}).error(function(){g.reject("An error occured while fetching data")}),g.promise},getSingleRoute:function(c,f){var g=b.defer(),h="/getdataapp",i=h+"/"+c+"/"+f;return a({method:"GET",cache:!1,url:e+i}).success(function(a){g.resolve(d(a))}).error(function(){g.reject("An error occured while fetching data")}),g.promise}}}]),angular.module("gogogoApp").filter("parseRoutes",function(){return function(a){var b={},c=a.map(function(a,b){var c={tm:a.transport_method,distance:+a.distance_inkm,id:a._id,teamid:a.teamid,endDatetime:+a.endDatetime,startDatetime:+a.startDatetime},d=polyline.decode(a.lineString),e=turf.lineString(d,c),e=turf.simplify(e,1e-5,!0);return e}),d=d3.nest().key(function(a){return a.properties.teamid}).entries(c),e=d.map(function(a){return a.key});return b.routes=turf.flip(turf.featureCollection(c)),b.teams=d,b.teamsList=e,b.dates=[d3.min(a,function(a){return a.startDatetime}),d3.max(a,function(a){return a.endDatetime})],b.dates[1]=d3.timeMinute.ceil(new Date(b.dates[1])).getTime(),b.dates[0]=d3.timeMinute.floor(new Date(b.dates[0])).getTime(),console.log(d),b}}),angular.module("gogogoApp").directive("map",["$timeout","$window",function(a,b){return{restrict:"A",replace:!1,link:function(a,b,c){mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var d=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[4.9,52.3667],minZoom:12,maxZoom:17,zoom:13});d.addControl(new mapboxgl.Navigation);var e=function(a){d.addSource("routes",{type:"geojson",data:a}),d.addLayer({id:"routes",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,0,0,0.5)","line-width":2}}),d.addLayer({id:"routes-hover",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,0,0,1)","line-width":3},filter:["==","id",""]}),d.on("mousemove",function(a){var b=d.queryRenderedFeatures(a.point,{layers:["routes"]});d.getCanvas().style.cursor=b.length?"pointer":"",b.length?d.setFilter("routes-hover",["==","id",b[0].properties.id]):d.setFilter("routes-hover",["==","id",""])}),d.on("mouseout",function(){d.setFilter("routes-hover",["==","id",""])});var b=turf.bbox(a);d.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:100})},f=function(a){d.setLayoutProperty("routes","visibility","none"),d.setLayoutProperty("routes-hover","visibility","none");var b=d.getSource("singleroute");if(b){d.setLayoutProperty("singleroute","visibility","visible"),b.setData(a);var c=turf.bbox(a);d.fitBounds([[c[0],c[1]],[c[2],c[3]]],{padding:100})}else{d.addSource("singleroute",{type:"geojson",data:a}),d.addLayer({id:"singleroute",type:"line",source:"singleroute",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":{property:"emotion",type:"categorical",stops:[["1","#d7191c"],["2","#fdae61"],["3","#ffffbf"],["4","#a6d96a"],["5","#1a9641"]]},"line-width":3}});var c=turf.bbox(a);d.fitBounds([[c[0],c[1]],[c[2],c[3]]],{padding:100})}};a.$watch("routes.features.length",function(b,c){b!=c&&b&&(d.loaded()?e(a.routes):d.on("load",function(){e(a.routes)}))}),a.$watch("singleRoute.features.length",function(b,c){b!=c&&b?d.loaded()?f(a.singleRoute):d.on("load",function(){f(a.singleRoute)}):b==c||b||(d.setLayoutProperty("routes","visibility","visible"),d.setLayoutProperty("routes-hover","visibility","visible"),d.setLayoutProperty("singleroute","visibility","none"))}),a.$watchGroup(["filters.bike","filters.walking","filters.selectedTeam","slider.minValue","slider.maxValue"],function(a,b,c){if(a[3]&&a[4]&&d.loaded()){var e=["in","tm"];a[0]&&e.push("bike"),a[1]&&e.push("walking"),a[2]?d.setFilter("routes",["all",e,["==","teamid",a[2]],[">","startDatetime",a[3]],["<","endDatetime",a[4]]]):d.setFilter("routes",["all",e,[">","startDatetime",a[3]],["<","endDatetime",a[4]]])}})}}}]),angular.module("gogogoApp").directive("minimap",function(){return{restrict:"A",replace:!1,scope:{route:"="},link:function(a,b,c){var d=turf.flip(a.route),e=100,f=100,g=d3.select(b[0]).append("canvas").attr("width",e).attr("height",f),h=g.node().getContext("2d"),i=d3.geoMercator().fitSize([e,f],d),j=d3.geoPath().projection(i).context(h);j(d),h.stroke()}}}),angular.module("gogogoApp").filter("routes",function(){return function(a,b){var c=a;return c?(c.forEach(function(a){var c=0;a.values.forEach(function(a){var d=b.bike?"bike":!1,e=b.walking?"walking":!1,f=a.properties.startDatetime>=b.minValue&&a.properties.endDatetime<=b.maxValue?!0:!1;a.properties.tm==d||a.properties.tm==e&&f?(a.properties.show=!0,c++):a.properties.show=!1}),a.shown=c}),c):void 0}}),angular.module("gogogoApp").directive("slideraxes",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d=d3.select(b[0]),e=b[0].getBoundingClientRect().width,f=30,g={top:5,right:0,bottom:5,left:0},h=e-g.left-g.right,i=(f-g.top-g.bottom,d.append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+g.left+","+g.top+")")),j=new Date(a.slider.options.floor),k=new Date(a.slider.options.ceil),l=d3.scaleTime().domain([j,k]).range([0,h]),m=d3.axisBottom(l).tickSizeOuter(0);i.call(m),a.$watch("slider.options",function(a,b){if(a!=b){var c=new Date(a.floor),d=new Date(a.ceil);l.domain([c,d]),i.call(m)}},!0)}}}),angular.module("gogogoApp").filter("parseSingleRoute",function(){return function(a){var b,c,d=a[0].route,e=a[0]._id,f=[],g=[];return d.forEach(function(a,h){if(a.coordinates.emotion!=c){if(g.length){var i=turf.lineString(g,{emotion:c,id:e,startDatetime:b});f.push(i),b=Math.round(+a.timestamp),g=[g[g.length-1]]}else g=[];b=Math.round(+a.timestamp),c=a.coordinates.emotion,g.push([+a.coordinates.longitude,+a.coordinates.latitude])}else g.push([+a.coordinates.longitude,+a.coordinates.latitude]);if(h==d.length-1){var i=turf.lineString(g,{emotion:c,id:e,startDatetime:b});f.push(i)}}),turf.featureCollection(f)}}),angular.module("gogogoApp").run(["$templateCache",function(a){a.put("views/explore.html",'<div class="container-fluid fullHeight"> <div class="row fullHeight"> <div class="col-md-6 flex"> <div class="filtersContainer"> <h3 class="mainTitle">GoGoGo</h3> <div class="row search"> <div class="col-md-6"> <input type="text" ng-model="searchTeam" placeholder="Search team" typeahead-on-select="onSelectedTeam($item, $model, $label, $event)" uib-typeahead="team for team in teamsList | filter:$viewValue " class="form-control"> </div> <div class="col-md-6"> <button ng-if="filters.selectedTeam" ng-click="removeTeam()" type="button" class="btn btn-default"> {{filters.selectedTeam}} <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span> </button> <button ng-click="isOpen = !isOpen" type="button" class="btn btn-default pull-right"> <span class="glyphicon glyphicon-filter" aria-hidden="true"></span> </button> </div> </div> </div> <div class="collapseWrapper" ng-class="{collapseHeight: !isOpen}"> <div class="filtersCollapse" ng-class="{filtersOpen: isOpen}"> <div class="row"> <div class="col-md-4"> <div class="checkbox-btn"> <span class="icon-Bike-1" aria-hidden="true"></span> <span class="checkbox-txt"> Bike </span> <span class="pull-right"> <input type="checkbox" ng-model="filters.bike"> </span> </div> </div> <div class="col-md-4"> <div class="checkbox-btn"> <span class="icon-Converse" aria-hidden="true"></span> <span class="checkbox-txt"> Walking </span> <span class="pull-right"> <input type="checkbox" ng-model="filters.walking"> </span> </div> </div> </div> <div class="sliderContainer"> <rzslider rz-slider-model="slider.minValue" rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider> <div style="width:100%" slideraxes> </div> </div> </div> </div> <div class="routesContainer"> <div ng-repeat="team in teams | filter: { key: filters.selectedTeam } | routes:filters "> <div ng-if="team.shown"> <h3 class="teamNumber">{{team.key}}</h3> <div class="media" ng-repeat="route in team.values" ng-if="route.properties.show" ng-click="getSingleRoute(team.key, route.properties.id)"> <div class="media-body"> <h6 class="routeNumber">route {{$index+1}}</h6> <p> <span ng-class="{walking:\'icon-Converse\', bike:\'icon-Bike-1\'}[route.properties.tm]" aria-hidden="true"></span> <span class="routeInfo">{{route.properties.distance}}</span>km in <span class="routeInfo">{{(route.properties.endDatetime-route.properties.startDatetime) | date:\'HH:mm:ss\':\'+000\'}}</span> </p> <p> Started on {{route.properties.startDatetime | date:\'MMM d, y\'}} at {{route.properties.startDatetime | date:\'HH:mm:ss\'}} and arrived at {{route.properties.endDatetime | date:\'HH:mm:ss\'}} </p> <!-- <button class="btn btn-default" ng-click="getSingleRoute(team.key, route.properties.id)">\n              <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>\n            </button>\n            <button class="btn btn-default" ng-click="removeSingleRoute()">\n              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>\n            </button>\n            --> <!-- <div class="singleRoute" uib-collapse="route.properties.id != singleRoute.features[0].properties.id"> --> <div class="singleRoute" ng-if="singleRoute && route.properties.id == singleRoute.features[0].properties.id"> <ul> <li ng-repeat="line in singleRoute.features"> <i class="em" ng-class="{1:\'em-tired_face\', 2:\'em-worried\',3:\'em-neutral_face\',4:\'em-blush\',5:\'em-smile\'}[line.properties.emotion]"></i> {{ line.properties.startDatetime | date:\'HH:mm:ss\' }} </li> </ul> </div> </div> <div class="media-right"> <div minimap route="route"></div> </div> </div> </div> </div> </div> </div> <div class="col-md-6 fullHeight"> <div id="map" class="fullHeight" map></div> </div> </div> </div>'),a.put("views/home.html",'<div class="container"> <div class="jumbotron"> <h1>GOGOGO is in da house!</h1> </div> </div> <div class="container"> <div class="row"> <div class="col-md-12"> <p> ready to type cool stuff. </p> <a href="#/explore" class="btn btn-default" role="button">try the app</a> </div> </div> </div>')}]);