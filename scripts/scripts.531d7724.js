"use strict";angular.module("gogogoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","angular.filter","rzModule"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/explore",{templateUrl:"views/explore.html",controller:"ExploreCtrl",controllerAs:"explore"}).when("/",{redirectTo:"/home"}).when("/report",{templateUrl:"views/report.html",controller:"ReportCtrl",controllerAs:"report"}).otherwise({redirectTo:"/home"})}]).config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),angular.module("gogogoApp").controller("HomeCtrl",function(){}),angular.module("gogogoApp").controller("ExploreCtrl",["$scope","apiservice",function(a,b){a.routes,a.singleRoute,a.singleTeam,a.singleTeamAvg,a.teams,a.errors,a.filters={bike:!0,walking:!0,selectedTeam:void 0,minValue:"",maxValue:""},a.isOpen=!1,a.mapCenter,a.setCenter=function(b,c){a.mapCenter={center:b,emotion:c}};var c=d3.timeFormat("%d/%m %H:%M");a.slider={minValue:0,maxValue:0,options:{ceil:0,floor:0,step:6e4,noSwitching:!0,translate:function(a){return c(new Date(a))},onEnd:function(b,c,d,e){"min"==e?a.filters.minValue=c:a.filters.maxValue=d}}},a.onSelectedTeam=function(b,c,d,e){a.removeSingleRoute(),a.searchTeam="",a.filters.selectedTeam=b,a.getSingleTeam(b)},a.removeTeam=function(){a.filters.selectedTeam=void 0,a.singleTeamAvg=void 0,a.removeSingleTeam()},a.removeSingleRoute=function(){a.singleRoute=null},a.removeSingleTeam=function(){a.singleTeam=null},a.getSingleRoute=function(c,d){a.singleRoute&&d==a.singleRoute.features[0].properties.id?a.removeSingleRoute():b.getSingleRoute(c,d).then(function(b){a.singleRoute=b,a.singleTeamAvg=d3.mean(b.features,function(a){return+a.properties.emotion}),a.singleTeamAvg=Math.round(a.singleTeamAvg)},function(b){a.errors=b})},a.getSingleTeam=function(c){b.getSingleTeam(c).then(function(b){a.singleTeam=b},function(b){a.errors=b})},b.getRoutes().then(function(b){a.routes=b.routes,a.teams=b.teams,a.teamsList=b.teamsList,a.slider.minValue=b.dates[0],a.filters.minValue=b.dates[0],a.slider.options.floor=b.dates[0],a.slider.maxValue=b.dates[1],a.filters.maxValue=b.dates[1],a.slider.options.ceil=b.dates[1]},function(b){a.errors=b})}]),angular.module("gogogoApp").factory("apiservice",["$http","$q","parseRoutesFilter","parseSingleRouteFilter","parseSingleTeamFilter",function(a,b,c,d,e){var f="http://149.210.213.121";return{getFile:function(c){var d=b.defer();return a.get(c).success(function(a){d.resolve(a)}).error(function(){d.reject("An error occured while fetching file")}),d.promise},getRoutes:function(d,e){var g=b.defer(),h="/getdataapp",i=d?e?h+"/"+d+"/"+e:h+"/"+d:h;return a({method:"GET",cache:!1,url:f+i}).success(function(a){g.resolve(c(a))}).error(function(){g.reject("An error occured while fetching data")}),g.promise},getSingleRoute:function(c,e){var g=b.defer(),h="/getdataapp",i=h+"/"+c+"/"+e;return a({method:"GET",cache:!1,url:f+i}).success(function(a){g.resolve(d(a))}).error(function(){g.reject("An error occured while fetching data")}),g.promise},getSingleTeam:function(c){var d=b.defer(),g="/getdataapp",h=g+"/"+c;return a({method:"GET",cache:!1,url:f+h}).success(function(a){d.resolve(e(a))}).error(function(){d.reject("An error occured while fetching data")}),d.promise},getRoutesAll:function(){var c=b.defer(),d="/getfulldataapp",e=d;return a({method:"GET",cache:!1,url:f+e}).success(function(a){c.resolve(a)}).error(function(){c.reject("An error occured while fetching data")}),c.promise}}}]),angular.module("gogogoApp").filter("parseRoutes",function(){return function(a){var b={},c=a.map(function(a,b){var c={tm:a.transport_method,distance:+a.distance_inkm,id:a._id,teamid:a.teamid,endDatetime:+a.endDatetime,startDatetime:+a.startDatetime},d=polyline.decode(a.lineString),e=turf.lineString(d,c),e=turf.simplify(e,1e-5,!0);return e}),d=d3.nest().key(function(a){return a.properties.teamid}).entries(c),e=d.map(function(a){return a.key});return b.routes=turf.flip(turf.featureCollection(c)),b.teams=d,b.teamsList=e,b.dates=[d3.min(a,function(a){return a.startDatetime}),d3.max(a,function(a){return a.endDatetime})],b.dates[1]=d3.timeMinute.ceil(new Date(b.dates[1])).getTime(),b.dates[0]=d3.timeMinute.floor(new Date(b.dates[0])).getTime(),b}}),angular.module("gogogoApp").directive("map",["$timeout","$window",function(a,b){return{restrict:"A",replace:!1,link:function(a,b,c){mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var d,e=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[4.9,52.3667],minZoom:8,maxZoom:17,zoom:13});e.addControl(new mapboxgl.NavigationControl);var f=function(b){e.addSource("routes",{type:"geojson",data:b}),e.addLayer({id:"routes",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(0,0,0,0.5)","line-width":2}}),e.addLayer({id:"routes-hover",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,255,255,1)","line-width":1,"line-gap-width":3},filter:["==","id",""]}),e.addLayer({id:"routes-hover-in",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#284347","line-width":3},filter:["==","id",""]}),e.on("mousemove",function(b){var c=e.queryRenderedFeatures(b.point,{layers:["routes"]});if(e.getCanvas().style.cursor=c.length?"pointer":"",c.length?(e.setFilter("routes-hover",["==","id",c[0].properties.id]),e.setFilter("routes-hover-in",["==","id",c[0].properties.id])):(e.setFilter("routes-hover",["==","id",""]),e.setFilter("routes-hover-in",["==","id",""])),e.getSource("singleteam")){var d=e.queryRenderedFeatures(b.point,{layers:["singleteam"]});if(e.getCanvas().style.cursor=d.length?"pointer":"",d.length)e.setFilter("singleteam",["==","id",d[0].properties.id]);else if("visible"==e.getLayoutProperty("singleteam","visibility")){var f=["in","tm"];a.filters.bike&&f.push("bike"),a.filters.walking&&f.push("walking"),e.setFilter("singleteam",["all",f,["==","teamid",a.filters.selectedTeam],[">","startDatetime",a.filters.minValue],["<","endDatetime",a.filters.maxValue]])}}}),e.on("click",function(b){var c=e.getLayoutProperty("routes","visibility");a.filters.selectedTeam?(e.setLayoutProperty("singleteam","visibility","visible"),a.removeSingleRoute(),a.$$phase||a.$apply()):a.filters.selectedTeam||"visible"==c||(a.removeSingleRoute(),a.$$phase||a.$apply());var d=e.queryRenderedFeatures(b.point,{layers:["routes-hover"]});if(d.length){var f=d[0];a.getSingleRoute(f.properties.teamid,f.properties.id);var g=$(".routesContainer"),h=$("#"+f.properties.id);g.animate({scrollTop:h.offset().top-g.offset().top+g.scrollTop()-$("ddn-sticky-wrapper").height()})}if(a.filters.selectedTeam){var i=e.queryRenderedFeatures(b.point,{layers:["singleteam"]});if(!i.length)return;var i=i[0];a.getSingleRoute(i.properties.teamid,i.properties.id);var g=$(".routesContainer"),h=$("#"+i.properties.id);g.animate({scrollTop:h.offset().top-g.offset().top+g.scrollTop()-$("ddn-sticky-wrapper").height()})}}),e.on("mouseout",function(){e.setFilter("routes-hover",["==","id",""]),e.setFilter("routes-hover-in",["==","id",""])});var c=turf.bbox(b);e.fitBounds([[c[0],c[1]],[c[2],c[3]]],{padding:100})},g=function(a){e.setLayoutProperty("routes","visibility","none"),e.setLayoutProperty("routes-hover","visibility","none"),e.setLayoutProperty("routes-hover-in","visibility","none"),e.getSource("singleteam")&&e.setLayoutProperty("singleteam","visibility","none"),d&&d.remove();var b=a.features[0].geometry.coordinates[0],c=a.features[a.features.length-1].geometry.coordinates[a.features[a.features.length-1].geometry.coordinates.length-1],f=turf.featureCollection([turf.point(b,{label:"start"}),turf.point(c,{label:"end"})]),g=e.getSource("singleroute");if(g){e.setLayoutProperty("singleroute","visibility","visible"),e.setLayoutProperty("startend","visibility","visible"),e.getSource("startend").setData(f),g.setData(a);var h=turf.bbox(a);e.fitBounds([[h[0],h[1]],[h[2],h[3]]],{padding:100})}else{e.addSource("singleroute",{type:"geojson",data:a}),e.addSource("startend",{type:"geojson",data:f}),e.addLayer({id:"singleroute",type:"line",source:"singleroute",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":{property:"emotion",type:"categorical",stops:[["1","#d7191c"],["2","#fdae61"],["3","#ffffbf"],["4","#a6d96a"],["5","#1a9641"]]},"line-width":3}}),e.addLayer({id:"startend",type:"symbol",source:"startend",layout:{"text-field":"{label}","text-transform":"uppercase","text-size":12,"text-offset":[0,1],"text-font":["Open Sans Semibold","Arial Unicode MS Bold"]}});var h=turf.bbox(a);e.fitBounds([[h[0],h[1]],[h[2],h[3]]],{padding:100})}},h=function(a){e.setLayoutProperty("routes","visibility","none"),e.setLayoutProperty("routes-hover","visibility","none"),e.setLayoutProperty("routes-hover-in","visibility","none"),d&&d.remove();var b=e.getSource("singleteam");if(b){e.setLayoutProperty("singleteam","visibility","visible"),b.setData(a);var c=turf.bbox(a);e.fitBounds([[c[0],c[1]],[c[2],c[3]]],{padding:100})}else{e.addSource("singleteam",{type:"geojson",data:a}),e.addLayer({id:"singleteam",type:"line",source:"singleteam",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":{property:"emotion",type:"categorical",stops:[["1","#d7191c"],["2","#fdae61"],["3","#ffffbf"],["4","#a6d96a"],["5","#1a9641"]]},"line-width":3}});var c=turf.bbox(a);e.fitBounds([[c[0],c[1]],[c[2],c[3]]],{padding:100})}};a.$watch("routes.features.length",function(b,c){b!=c&&b&&(e.loaded()?f(a.routes):e.on("load",function(){f(a.routes)}))}),a.$watch("mapCenter",function(a,b){if(a!=b&&a){d&&d.remove();var c=d3.select("body").append("div");c.append("i").attr("class",function(){var b;switch(a.emotion){case"1":b="em-tired_face";break;case"2":b="em-worried";break;case"3":b="em-neutral_face";break;case"4":b="em-blush";break;case"5":b="em-smile"}return"em "+b}),d=new mapboxgl.Marker(c.node(),{offset:[-9,-9]}).setLngLat(a.center).addTo(e),e.flyTo({center:a.center,zoom:17})}},!0),a.$watch("singleRoute.features.length",function(b,c){b!=c&&b?e.loaded()?g(a.singleRoute):e.on("load",function(){g(a.singleRoute)}):b==c||b||(a.filters.selectedTeam?e.getSource("singleteam")&&e.setLayoutProperty("singleteam","visibility","visible"):(e.setLayoutProperty("routes","visibility","visible"),e.setLayoutProperty("routes-hover","visibility","visible"),e.setLayoutProperty("routes-hover-in","visibility","visible")),e.setLayoutProperty("singleroute","visibility","none"),e.setLayoutProperty("startend","visibility","none"),d&&d.remove())}),a.$watch("singleTeam.features.length",function(b,c){b!=c&&b?h(a.singleTeam):b==c||b||(e.setLayoutProperty("routes","visibility","visible"),e.setLayoutProperty("routes-hover","visibility","visible"),e.setLayoutProperty("routes-hover-in","visibility","visible"),e.setLayoutProperty("singleteam","visibility","none"))}),a.$watchGroup(["filters.bike","filters.walking","filters.selectedTeam","filters.minValue","filters.maxValue"],function(a,b,c){if(a[3]&&a[4]&&e.getSource("routes")){c.removeSingleRoute();var d=["in","tm"];a[0]&&d.push("bike"),a[1]&&d.push("walking"),a[2]?(e.setFilter("routes",["all",d,["==","teamid",a[2]],[">","startDatetime",a[3]],["<","endDatetime",a[4]]]),e.getSource("singleteam")&&e.setFilter("singleteam",["all",d,["==","teamid",a[2]],[">","startDatetime",a[3]],["<","endDatetime",a[4]]])):(e.setLayoutProperty("routes","visibility","visible"),e.setLayoutProperty("routes-hover","visibility","visible"),e.setLayoutProperty("routes-hover-in","visibility","visible"),e.setFilter("routes",["all",d,[">","startDatetime",a[3]],["<","endDatetime",a[4]]]))}})}}}]),angular.module("gogogoApp").directive("minimap",function(){return{restrict:"A",replace:!1,scope:{route:"="},link:function(a,b,c){function d(){var a=window.devicePixelRatio||1,b=[i.webkitBackingStorePixelRatio,i.mozBackingStorePixelRatio,i.msBackingStorePixelRatio,i.oBackingStorePixelRatio,i.backingStorePixelRatio,1].reduce(function(a,b){return a||b});return a/b}var e=turf.flip(a.route),f=70,g=70,h=d3.select(b[0]).append("canvas"),i=h.node().getContext("2d"),j=d();h.attr("width",f*j).attr("height",g*j).style("width",f+"px").style("height",g+"px"),i.scale(j,j);var k=d3.geoMercator().fitSize([f,g],e),l=d3.geoPath().projection(k).context(i);l(e),i.stroke()}}}),angular.module("gogogoApp").filter("routes",function(){return function(a,b){var c=a;return c?(c.forEach(function(a){var c=0;a.values.forEach(function(a){var d=b.bike?"bike":!1,e=b.walking?"walking":!1,f=a.properties.startDatetime>=b.minValue&&a.properties.endDatetime<=b.maxValue?!0:!1;a.properties.tm==d||a.properties.tm==e&&f?(a.properties.show=!0,c++):a.properties.show=!1}),a.shown=c}),c):void 0}}),angular.module("gogogoApp").directive("slideraxes",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d=d3.select(b[0]),e=b[0].getBoundingClientRect().width,f=30,g={top:5,right:0,bottom:5,left:0},h=e-g.left-g.right,i=(f-g.top-g.bottom,d.append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+g.left+","+g.top+")")),j=new Date(a.slider.options.floor),k=new Date(a.slider.options.ceil),l=d3.scaleTime().domain([j,k]).range([0,h]),m=d3.axisBottom(l).tickSizeOuter(0);i.call(m),a.$watch("slider.options",function(a,b){if(a!=b){var c=new Date(a.floor),d=new Date(a.ceil);l.domain([c,d]),i.call(m)}},!0)}}}),angular.module("gogogoApp").filter("parseSingleRoute",function(){return function(a){var b,c,d=a[0].route,e=a[0]._id,f=[],g=[];return d.forEach(function(a,h){if(a.coordinates.emotion!=c){if(g.length){var i=turf.lineString(g,{emotion:c,id:e,startDatetime:b});f.push(i),b=Math.round(+a.timestamp),g=[g[g.length-1]]}else g=[];b=Math.round(+a.timestamp),c=a.coordinates.emotion,g.push([+a.coordinates.longitude,+a.coordinates.latitude])}else g.push([+a.coordinates.longitude,+a.coordinates.latitude]);if(h==d.length-1){var i=turf.lineString(g,{emotion:c,id:e,startDatetime:b});f.push(i)}}),turf.featureCollection(f)}}),angular.module("gogogoApp").directive("ddnStickyWrapper",["$window","$timeout",function(a,b){var c,d=[],e=function(){$(".routesContainer")[0].scrollHeight!=c&&(c=$(".routesContainer")[0].scrollHeight,d=[],$("ddn-sticky").each(function(){$(this).removeClass("fixed2"),$(this).removeAttr("style"),$(this).data("pos",$(this).position().top+angular.element(".routesContainer").scrollTop()),d.push(angular.element(this))})),angular.forEach(d,function(a,b){var c=a[0],e=a.data("pos");if(e<=angular.element(".routesContainer").scrollTop()){var f=d[b+1],g=f?f[0]:null,h=g?f.data("pos"):0;a.addClass("fixed2"),a.css("width",$(c).parent().width()),a.css("top",angular.element(".routesContainer").position().top+"px"),g&&h<=angular.element(".routesContainer").scrollTop()&&(a.addClass("absolute"),a.removeClass("fixed2"))}else{var i=d[b-1];i?i[0]:null;a.removeClass("absolute").removeAttr("style"),a.removeClass("fixed2")}})},f=function(a,f,g){b(function(){c=$(".routesContainer")[0].scrollHeight;var a=f.children()[0],b=angular.element(a);f.css("height",a.clientHeight+"px"),b.data("pos",$(a).position().top),d.push(b),angular.element(".routesContainer").off("scroll",e).on("scroll",e)}),a.$watch("isOpen",function(a,b){a!=b&&a?$(f.children()[0]).hasClass("fixed2")&&$(f.children()[0]).css("top",angular.element(".routesContainer").position().top+$(".filtersCollapse").height()+"px"):a==b||a||$(f.children()[0]).hasClass("fixed2")&&$(f.children()[0]).css("top",$(f.children()[0]).css("top").replace("px","")-$(".filtersCollapse").height()+"px")})};return{restrict:"E",transclude:!0,template:"<ddn-sticky ng-transclude></ddn-sticky>",link:f}}]),angular.module("gogogoApp").directive("homemap",function(){return{restrict:"A",replace:!1,link:function(a,b,c){mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";new mapboxgl.Map({container:"map-bg",style:"mapbox://styles/mapbox/satellite-v9",center:[4.9,52.3667],minZoom:12,maxZoom:17,zoom:13,interactive:!1})}}}),angular.module("gogogoApp").filter("parseSingleTeam",function(){return function(a){var b=[];return a.forEach(function(a){var c,d=a.route,e=a._id,f=a.teamid,g=a.transport_method,h=a.startDatetime,i=a.endDatetime,j=[];d.forEach(function(a,k){if(a.coordinates.emotion!=c){if(j.length){var l=turf.lineString(j,{emotion:c,id:e,teamid:f,tm:g,startDatetime:h,endDatetime:i,chunkid:e+h});b.push(l),h=Math.round(+a.timestamp),j=[j[j.length-1]]}else j=[];h=Math.round(+a.timestamp),c=a.coordinates.emotion,j.push([+a.coordinates.longitude,+a.coordinates.latitude])}else j.push([+a.coordinates.longitude,+a.coordinates.latitude]);if(k==d.length-1){var l=turf.lineString(j,{emotion:c,id:e,teamid:f,tm:g,startDatetime:h,endDatetime:i,chunkid:e+h});b.push(l)}})}),turf.featureCollection(b)}}),angular.module("gogogoApp").controller("ReportCtrl",["$scope","apiservice","parseSingleTeamFilter","$location",function(a,b,c,d){a.rawRoutes,a.routes,a.gridFeatures,a.grid,a.reportType="all",a.totalTeams=0,a.totalRoutes=0,a.dataPoints=0,a.areas=0,a.poi=0,a.poiDataPoints=0,a.loading=!0;var e=new Worker("worker/collect.js");a.checkReport=function(b){return a.reportType===b},b.getFile("data/ams_grid.json").then(function(d){a.grid=d,b.getRoutesAll().then(function(b){a.rawRoutes=b,a.routes=c(b),a.totalRoutes=b.length,a.totalTeams=d3.nest().key(function(a){return a.teamid}).entries(b).length,b.forEach(function(b){a.dataPoints=a.dataPoints+b.route.length}),a.computeGrid(b,d)},function(b){a.errors=b})},function(b){a.errors=b}),a.computeGrid=function(c,d){e.postMessage({input:c,grid:d}),e.onmessage=function(c){var d=c.data;d.features=d.features.filter(function(a){return a.properties.emotions.length}),d.features.forEach(function(a,b){a.properties.id="id_"+b,a.properties.count=a.properties.emotions.length;var c=d3.nest().key(function(a){return a}).entries(a.properties.emotions);c=c.sort(function(a,b){return d3.descending(a.values.length,b.values.length)}),a.properties.emotions=c[0].key}),a.gridFeatures=d,a.areas=a.gridFeatures.features.length,b.getFile("data/poi.json").then(function(b){var c=[];a.poi=b.features.length,b.features.forEach(function(b){a.gridFeatures.features.forEach(function(d){turf.inside(b,d)&&(d.properties.name=b.properties.name,d.properties.category=b.properties.category,c.push(d),a.poiDataPoints=a.poiDataPoints+d.properties.count)})}),a.poiGrid=turf.featureCollection(c),a.loading=!1},function(a){console.log(a)})}}}]),angular.module("gogogoApp").directive("mapall",["$timeout","$window","$filter",function(a,b,c){return{restrict:"A",replace:!1,link:function(a,b,d){mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var e=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[4.9,52.3667],minZoom:8,maxZoom:17,zoom:13});e.addControl(new mapboxgl.NavigationControl);var f=function(a){if(e.getSource("routes"))e.setLayoutProperty("routes","visibility","visible"),e.setLayoutProperty("routes-hover","visibility","visible"),e.setLayoutProperty("routes-hover-in","visibility","visible"),e.setLayoutProperty("grid","visibility","none"),e.setLayoutProperty("grid-hover","visibility","none"),e.setLayoutProperty("gridPoi","visibility","none"),e.setLayoutProperty("gridPoiLabel","visibility","none"),e.setLayoutProperty("gridPoiLine","visibility","none"),e.easeTo({pitch:0});else{e.addSource("routes",{type:"geojson",data:a}),e.addLayer({id:"routes",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":{property:"emotion",type:"categorical",stops:[["1","rgba(215, 25, 28,0.25)"],["2","rgba(253, 174, 97,0.25)"],["3","rgba(255, 255, 191,0.25)"],["4","rgba(166, 217, 106,0.25)"],["5","rgba(26, 150, 65,0.25)"]]},"line-width":3}}),e.addLayer({id:"routes-hover",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"rgba(255,255,255,1)","line-width":1,"line-gap-width":4},filter:["==","chunkid",""]}),e.addLayer({id:"routes-hover-in",type:"line",source:"routes",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":{property:"emotion",type:"categorical",stops:[["1","rgba(215, 25, 28,1)"],["2","rgba(253, 174, 97,1)"],["3","rgba(255, 255, 191,1)"],["4","rgba(166, 217, 106,1)"],["5","rgba(26, 150, 65,1)"]]},"line-width":4},filter:["==","chunkid",""]});var b=turf.bbox(a);e.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:100})}e.on("mousemove",function(a){if(e.getSource("routes")){var b=e.queryRenderedFeatures(a.point,{layers:["routes"]});e.getCanvas().style.cursor=b.length?"pointer":""}}),e.on("click",function(a){var b=e.queryRenderedFeatures(a.point,{layers:["routes"]});if(!b.length)return e.setFilter("routes-hover-in",["==","chunkid",""]),void e.setFilter("routes-hover",["==","chunkid",""]);e.setFilter("routes-hover-in",["==","chunkid",b[0].properties.chunkid]),e.setFilter("routes-hover",["==","chunkid",b[0].properties.chunkid]);var d,f=b[0];switch(f.properties.emotion){case"1":d="#d7191c";break;case"2":d="#fdae61";break;case"3":d="#c7c732";break;case"4":d="#a6d96a";break;case"5":d="#1a9641"}var g=Math.round(100*turf.lineDistance(f))/100,h=c("date")(f.properties.startDatetime,"MMM d, y")+" at "+c("date")(f.properties.startDatetime,"HH:mm:ss"),i='<span class="popupTitle">'+f.properties.teamid+'</span><br><span class="popupSubTitle"><span style="color:'+d+';">'+g+" km </span>by "+f.properties.tm+"<br>on "+h+"</span>";(new mapboxgl.Popup).setLngLat(e.unproject(a.point)).setHTML(i).addTo(e)})},g=function(a){var b=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1,offset:[10,-10],anchor:"bottom-left"});if(e.setLayoutProperty("routes","visibility","none"),e.setLayoutProperty("routes-hover","visibility","none"),e.setLayoutProperty("routes-hover-in","visibility","none"),e.getSource("gridPoi")&&(e.setLayoutProperty("gridPoi","visibility","none"),e.setLayoutProperty("gridPoiLabel","visibility","none"),e.setLayoutProperty("gridPoiLine","visibility","none")),e.getSource("grid"))e.setLayoutProperty("grid","visibility","visible"),e.setLayoutProperty("grid-hover","visibility","visible"),e.easeTo({pitch:50});else{e.addSource("grid",{type:"geojson",data:a});var c=d3.extent(a.features,function(a){return a.properties.count});d3.scaleLinear().range([10,500]).domain(c);e.addLayer({id:"grid",type:"fill",source:"grid",paint:{"fill-opacity":.55,"fill-color":{property:"emotions",type:"categorical",stops:[["1","rgba(215, 25, 28,1)"],["2","rgba(253, 174, 97,1)"],["3","rgba(255, 255, 191,1)"],["4","rgba(166, 217, 106,1)"],["5","rgba(26, 150, 65,1)"]]},"fill-extrude-base":0,"fill-extrude-height":{stops:[[c[0],10],[c[1],500]],property:"count",base:1}}}),e.addLayer({id:"grid-hover",type:"fill",source:"grid",paint:{"fill-opacity":1,"fill-color":{property:"emotions",type:"categorical",stops:[["1","rgba(215, 25, 28,1)"],["2","rgba(253, 174, 97,1)"],["3","rgba(255, 255, 191,1)"],["4","rgba(166, 217, 106,1)"],["5","rgba(26, 150, 65,1)"]]},"fill-extrude-base":0,"fill-extrude-height":{stops:[[c[0],10],[c[1],500]],property:"count",base:1}},filter:["==","id",""]});var d=turf.centroid(a).geometry.coordinates;e.easeTo({pitch:50,center:d})}e.on("mousemove",function(a){var c=e.queryRenderedFeatures(a.point,{layers:["grid"]});if(!c.length)return b.remove(),void e.setFilter("grid-hover",["==","id",""]);e.getCanvas().style.cursor=c.length?"crosshair":"";var d=c[0];e.setFilter("grid-hover",["==","id",d.properties.id]);var f={1:"em-tired_face",2:"em-worried",3:"em-neutral_face",4:"em-blush",5:"em-smile"},g='<span class="popupSubTitle"><b>'+d.properties.count+'</b> tracked points<br>average emotion: <i class="em '+f[d.properties.emotions]+'"></i></span>';b.setLngLat(e.unproject(a.point)).setHTML(g).addTo(e)})},h=function(a){var b=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1,offset:[10,-10],anchor:"bottom-left"});if(e.setLayoutProperty("routes","visibility","none"),e.setLayoutProperty("routes-hover","visibility","none"),e.setLayoutProperty("routes-hover-in","visibility","none"),e.getSource("grid")&&(e.setLayoutProperty("grid","visibility","none"),e.setLayoutProperty("grid-hover","visibility","none")),e.getSource("gridPoi"))e.setLayoutProperty("gridPoi","visibility","visible"),e.setLayoutProperty("gridPoiLabel","visibility","visible"),e.setLayoutProperty("gridPoiLine","visibility","visible"),e.easeTo({pitch:0});else{e.addSource("gridPoi",{type:"geojson",data:a});var c=d3.extent(a.features,function(a){return a.properties.count});d3.scaleLinear().range([10,500]).domain(c);e.addLayer({id:"gridPoi",type:"fill",source:"gridPoi",paint:{"fill-opacity":1,"fill-color":{property:"emotions",type:"categorical",stops:[["1","rgba(215, 25, 28,1)"],["2","rgba(253, 174, 97,1)"],["3","rgba(255, 255, 191,1)"],["4","rgba(166, 217, 106,1)"],["5","rgba(26, 150, 65,1)"]]},"fill-outline-color":{property:"category",type:"categorical",stops:[["","rgba(0,0,0,0)"],["Café","#045a8d"],["Cultureel","#74a9cf"],["includeeditGroen","#810f7c"],["Horeca","#636363"],["Onderwijs","#993404"]]}}}),e.addLayer({id:"gridPoiLine",type:"line",source:"gridPoi",paint:{"line-width":3,"line-color":{property:"category",type:"categorical",stops:[["","rgba(0,0,0,0)"],["Café","#045a8d"],["Cultureel","#74a9cf"],["includeeditGroen","#810f7c"],["Horeca","#636363"],["Groen","#c51b8a"],["Onderwijs","#993404"]]}}}),e.addLayer({id:"gridPoiLabel",type:"symbol",source:"gridPoi",layout:{"text-field":"{name}","text-font":["Open Sans Semibold","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"#fff","text-halo-color":"#000000","text-halo-width":2}});var d=turf.centroid(a).geometry.coordinates;e.easeTo({pitch:0,center:d})}e.on("mousemove",function(a){var c=e.queryRenderedFeatures(a.point,{layers:["gridPoi"]});if(!c.length)return void b.remove();e.getCanvas().style.cursor=c.length?"crosshair":"";var d=c[0],f={1:"em-tired_face",2:"em-worried",3:"em-neutral_face",4:"em-blush",5:"em-smile"},g='<span class="popupSubTitle"><b>'+d.properties.count+'</b> tracked points<br>Average emotion: <i class="em '+f[d.properties.emotions]+'"></i><br>Category: <b>'+d.properties.category+"</b></span>";b.setLngLat(e.unproject(a.point)).setHTML(g).addTo(e)})};a.$watch("routes.features.length",function(b,c){b!=c&&b&&(e.loaded()?f(a.routes):e.on("load",function(){f(a.routes)}))}),a.$watch("reportType",function(b,c){b!=c&&b&&("average"==b?g(a.gridFeatures):"all"==b?f(a.routes):"poi"==b&&h(a.poiGrid))})}}}]),angular.module("gogogoApp").run(["$templateCache",function(a){a.put("views/explore.html",'<div class="container-fluid fullHeight"> <div class="row fullHeight"> <div class="col-md-4 flex"> <div class="filtersContainer"> <div class="mainTitle"> <span class="pull-left backhome"> <a href="#/home"> <span class="icon-Left-7" aria-hidden="true"></span> home </a> </span> <a href="#/home"> <img src="images/logo.be1f236f.svg"> </a> </div> <div class="row search"> <div class="col-md-6"> <input type="text" ng-model="searchTeam" placeholder="Search team" typeahead-on-select="onSelectedTeam($item, $model, $label, $event)" uib-typeahead="team for team in teamsList | filter:$viewValue " class="form-control"> </div> <div class="col-md-6"> <button ng-if="filters.selectedTeam" ng-click="removeTeam()" type="button" class="btn btn-default"> {{filters.selectedTeam}} <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span> </button> <button ng-click="isOpen = !isOpen" type="button" class="btn btn-default pull-right"> <span class="glyphicon glyphicon-filter" aria-hidden="true"></span> </button> </div> </div> </div> <div class="collapseWrapper" ng-class="{collapseHeight: !isOpen}"> <div class="filtersCollapse" ng-class="{filtersOpen: isOpen}"> <div class="row"> <div class="col-md-6"> <div class="checkbox-btn"> <span class="icon-Bike-1" aria-hidden="true"></span> <span class="checkbox-txt"> Bike </span> <span class="pull-right"> <input type="checkbox" ng-model="filters.bike"> </span> </div> </div> <div class="col-md-6"> <div class="checkbox-btn"> <span class="icon-Converse" aria-hidden="true"></span> <span class="checkbox-txt"> Walking </span> <span class="pull-right"> <input type="checkbox" ng-model="filters.walking"> </span> </div> </div> </div> <div class="sliderContainer"> <rzslider rz-slider-model="slider.minValue" rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider> <div style="width:100%" slideraxes> </div> </div> </div> </div> <div class="routesContainer"> <div ng-if="team.shown" ng-repeat="team in teams | filter:{key: filters.selectedTeam}:true | routes:filters "> <!-- <div ng-if="team.shown"> --> <ddn-sticky-wrapper> <p class="clearfix teamHeader"> <span class="teamNumber pull-left">TEAM {{team.key}}</span> <span class="teamRoutes pull-right">{{ team.values.length}} route{{team.values.length>1?\'s\':\'\'}}</span> </p> </ddn-sticky-wrapper> <div class="media" ng-class="{\'mediaActive\':route.properties.id == singleRoute.features[0].properties.id}" ng-attr-id="{{ route.properties.id }}" ng-repeat="route in team.values" ng-if="route.properties.show" ng-click="getSingleRoute(team.key, route.properties.id)"> <div class="media-body"> <p> {{route.properties.startDatetime | date:\'MMM d, y\'}} at {{route.properties.startDatetime | date:\'HH:mm:ss\'}} </p> <p> <span ng-class="{walking:\'icon-Converse\', bike:\'icon-Bike-1\'}[route.properties.tm]" aria-hidden="true"></span> <span class="routeInfo">{{route.properties.distance}}</span>km in <span class="routeInfo">{{(route.properties.endDatetime-route.properties.startDatetime) | date:\'HH:mm:ss\':\'+000\'}}</span> <span class="meanRoute"> <i class="em" ng-if="singleTeamAvg && route.properties.id == singleRoute.features[0].properties.id" ng-class="{1:\'em-tired_face\', 2:\'em-worried\',3:\'em-neutral_face\',4:\'em-blush\',5:\'em-smile\'}[singleTeamAvg]"> </i> </span> </p> </div> <div class="media-right"> <div minimap route="route"></div> </div> <div class="singleRoute" ng-if="singleRoute && route.properties.id == singleRoute.features[0].properties.id"> <ul> <li> START <span class="emoStep">{{route.properties.startDatetime | date:\'EEEE HH:mm:ss\'}}</span> </li> <li ng-repeat="line in singleRoute.features"> <i class="em" ng-mouseover="setCenter(line.geometry.coordinates[0], line.properties.emotion)" ng-class="{1:\'em-tired_face\', 2:\'em-worried\',3:\'em-neutral_face\',4:\'em-blush\',5:\'em-smile\'}[line.properties.emotion]"> </i> {{(route.properties.endDatetime-route.properties.startDatetime)-(route.properties.endDatetime-line.properties.startDatetime) | date:\'HH:mm:ss\':\'+000\'}} <br> <div class="emoLine" ng-class="{1:\'tired_face\', 2:\'worried\',3:\'neutral_face\',4:\'blush\',5:\'smile\'}[line.properties.emotion]"></div> </li> <li> END <span class="emoStep">{{route.properties.endDatetime | date:\'EEEE HH:mm:ss\'}}</span> </li> </ul> </div> </div> <!-- </div> shown --> </div> </div> </div> <div class="col-md-8 fullHeight"> <div id="map" class="fullHeight" map></div> </div> </div> </div> <div class="visible-xs visible-sm"> <div class="splashMobile"> <div> <p> <b>Sorry!</b> </p> <p> In order to explore this website, you need a larger screen. </p> <p> <a href="mailto:?Subject=Gogogo%20app%20link&Body=Hi%2C%0A%0Athis%20is%20the%20link%3A%0Ahttp%3A//calib.ro/gogogo-live%0A%0Ahave%20a%20nice%20day%21%0Athe%20Gogogo%20team">Send an e-mail</a> as a reminder. </p> </div> </div> </div>'),a.put("views/home.html",'<div id="map-bg" homemap> </div> <div class="container-fluid flexHome"> <div class="rowHomeFlex"> <div class="row"> <div class="col-md-12"> <p> <img class="logo" src="images/logo.be1f236f.svg" height="auto"> </p> </div> </div> </div> <div class="rowHomeFlex"> <div class="row desc"> <div class="col-md-5 col-md-offset-1"> <p class="prdesc"> The GOGOGO project was a data sprint that was held from 12 - 26 November 2016 in Amsterdam. The aim was to log customer journeys of people on the Knowledge Mile: the area that runs from the Nieuwmarkt to the Amstel train station. The data sprint was organized by the Citizen Data Lab, in collaboration with the Media Information and Communication programme of the Amsterdam University of Applied Sciences, Calibro (IT), and Dutch Railways (NS). 300+ students participated to collect over 206 routes, more than 94,000 unique data entries and over 98 hours of logged route data. </p> <a href="#/explore" class="homeExplore btn btn-default btn-lg" role="button"> explorer </a> <a href="#/report" class="homeExplore btn btn-default btn-lg" role="button"> reports </a> </div> <div class="col-md-4 col-md-offset-1"> <div class="row"> <div class="col-md-6 datapoints"> <h2>300</h2> <p> students </p> </div> <div class="col-md-6 datapoints"> <h2>206</h2> <p> routes </p> </div> </div> <div class="row"> <div class="col-md-6 datapoints"> <h2>98</h2> <p> hours </p> </div> <div class="col-md-6 datapoints"> <h2>94k</h2> <p> data points </p> </div> </div> <div class="row"> <div class="col-md-12"> <div class="credits clearfix"> <div class="author pull-left"> <p> a project by </p> <a href="http://www.citizendatalab.org/" target="_blank"> <img src="images/cdl.2d1c455c.svg"> </a> </div> <div class="author pull-left"> <p> designed by </p> <a href="http://calib.ro" target="_blank"> <img src="images/calibro.6b4d9070.svg"> </a> </div> <div class="author pull-left"> <p> in collaboration with </p> <a href="http://www.amsterdamcreativeindustries.com/" target="_blank"> <img src="images/ACICE.23733d4d.png" width="78" height="auto"> </a> </div> </div> </div> </div> </div> </div> </div> </div>'),
a.put("views/report.html",'<div class="container-fluid fullHeight"> <div class="row fullHeight"> <div class="col-md-4 flex reportFlexCont"> <div class="filtersContainer"> <div class="mainTitle"> <span class="pull-left backhome"> <a href="#/home"> <span class="icon-Left-7" aria-hidden="true"></span> home </a> </span> <a href="#/home"> <img src="images/logo.be1f236f.svg"> </a> </div> </div> <div class="reportsContainer"> <div class="media" ng-class="{\'mediaActive\': checkReport(\'all\')}" ng-click="reportType = \'all\'"> <div class="media-body"> <p> {{totalRoutes}} routes - {{totalTeams}} teams </p> <p> <span class="routeInfoReport">All routes with emotions</span> </p> </div> <div class="media-right"> <span class="glyphicon glyphicon-menu-right"></span> </div> </div> <div class="media" ng-class="{\'mediaActive\': checkReport(\'average\'), \'mediaDisabled\': loading}" ng-click="reportType = \'average\'"> <div class="media-body"> <p> {{areas}} areas - {{dataPoints | number:0}} data points </p> <p> <span class="routeInfoReport">Average emotion per area</span> </p> </div> <div class="media-right"> <span class="glyphicon" ng-class="{true: \'glyphicon-refresh spinning\', false: \'glyphicon-menu-right\'}[loading]"></span> </div> </div> <div class="media" ng-class="{\'mediaActive\': checkReport(\'poi\'), \'mediaDisabled\': loading}" ng-click="reportType = \'poi\'"> <div class="media-body"> <p> {{poi}} points of interest - {{poiDataPoints | number:0}} data points </p> <p> <span class="routeInfoReport">Points of interest</span> </p> </div> <div class="media-right"> <span class="glyphicon" ng-class="{true: \'glyphicon-refresh spinning\', false: \'glyphicon-menu-right\'}[loading]"></span> </div> </div> </div> <div class="legendContainer"> <div class="row"> <div class="col-md-4"> <h3> how to read the map </h3> </div> <div class="col-md-8" ng-if="reportType == \'all\'"> <p> <b>COLOR</b>: How do students perceive the area they are passing through? </p> <p> <img class="legendHelper" src="images/color-legend.c476225d.svg"> </p> </div> <div class="col-md-8" ng-if="reportType == \'average\'"> <p> <b>COLOR</b>: Most prominent mood per area registered by data sprint students. </p> <p> <img class="legendHelper" src="images/color-legend.c476225d.svg"> </p> <p> <b>AREA</b> </p> <p> <img src="images/block-legend.da1cd9db.svg"> </p> </div> <div class="col-md-8" ng-if="reportType == \'poi\'"> <p> <b>COLOR</b>: most prominent mood per point of interest registered by data sprint students </p> <p> <img class="legendHelper" src="images/color-legend.c476225d.svg"> </p> <p> <b>STROKE</b>: point of interest category </p> <p> <img class="legendHelper" src="images/cat-legend.2b49c55c.svg"> </p> </div> </div> </div> </div> <div class="col-md-8 fullHeight"> <div id="map" class="fullHeight" mapall></div> </div> </div> </div> <div class="visible-xs visible-sm"> <div class="splashMobile"> <div> <p> <b>Sorry!</b> </p> <p> In order to explore this website, you need a larger screen. </p> <p> <a href="mailto:?Subject=Gogogo%20app%20link&Body=Hi%2C%0A%0Athis%20is%20the%20link%3A%0Ahttp%3A//calib.ro/gogogo-live%0A%0Ahave%20a%20nice%20day%21%0Athe%20Gogogo%20team">Send an e-mail</a> as a reminder. </p> </div> </div> </div>')}]);